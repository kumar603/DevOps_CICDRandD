name: CI Pipeline - Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ================================
  # STAGE 1: BUILD
  # ================================
  build:
    name: "Stage 1: Build"
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup .NET 8
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'
    
    - name: "[1.1] Restore dependencies"
      run: dotnet restore
    
    - name: "[1.2] Build solution (Release)"
      run: dotnet build --configuration Release --no-restore
  
  # ================================
  # STAGE 2: TEST
  # ================================
  test:
    name: "Stage 2: Test"
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup .NET 8
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: "[2.1] Run Unit Tests"
      run: dotnet test src/DevopsStack.UnitTests/DevopsStack.UnitTests.csproj --no-build --verbosity normal
    
    - name: "[2.2] Run Integration Tests"
      run: dotnet test src/DevopsStack.IntegrationTests/DevopsStack.IntegrationTests.csproj --no-build --verbosity normal
  
  # ================================
  # STAGE 3: PACKAGE
  # ================================
  package:
    name: "Stage 3: Package"
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup .NET 8
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: "[3.1] Publish application"
      run: dotnet publish src/DevopsStack.API/DevopsStack.API.csproj -c Release -o ./publish
    
    - name: "[3.2] Upload build artifacts"
      uses: actions/upload-artifact@v3
      with:
        name: published-app
        path: ./publish

